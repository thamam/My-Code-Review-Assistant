# ATDD Checklist - Requirements Audit Gaps

**Date:** 2026-01-23
**Author:** Murat (TEA Agent)
**Primary Test Level:** E2E / Unit

---

## Story Summary

Address the 15 high-priority coverage gaps identified during the Requirements Traceability Audit. These gaps span core Agent reasoning, performance NFRs, and UX safety/interactivity.

**As a** Developer
**I want** to ensure the core foundations of the "Theia" agent and runtime are verified
**So that** I can build new features on a stable and predictable platform.

---

## Acceptance Criteria

1. **Agent Reasoning**: Verify self-correction, tool routing (search/read), and repair mode context.
2. **Safety**: Verify Gatekeeper intercepts sensitive tools (write_file) for user approval.
3. **Performance**: Verify lazy load latency < 2s, ghost file caching, and context debounce.
4. **UX**: Verify agent yields on barge-in and focus locking prevents jarring navigation.
5. **Voice**: Verify TTS sanitization removes code/markdown syntax from voice track.

---

## Failing Tests Created (RED Phase)

### E2E Tests (8 tests)

**Files:** 
- `tests/agent-intelligence.spec.ts`
- `tests/safety-gate.spec.ts`
- `tests/performance-ux.spec.ts`

- ✅ **Test:** FR-004: Agent self-corrects after tool failure
  - **Status:** RED - Timeout/Event Missing
  - **Verifies:** Self-Correction: Failure triggers re-planning.
- ✅ **Test:** FR-007 & FR-010: Agent uses search and read tools
  - **Status:** RED - Timeout
  - **Verifies:** Agent can search codebase and read file contents.
- ✅ **Test:** FR-011: Sensitive tool calls are intercepted
  - **Status:** RED - Timeout/Modal Missing
  - **Verifies:** Gatekeeper intercepts sensitive tools.
- ✅ **Test:** FR-035 & NFR-006: Ghost node lazy load latency
  - **Status:** RED - Timeout/Interaction Failure
  - **Verifies:** Lazy load latency < 2s.
- ✅ **Test:** NFR-007: Ghost files are cached
  - **Status:** RED - Timeout
  - **Verifies:** Ghost File Caching works.
- ✅ **Test:** FR-041: Agent yields on barge-in
  - **Status:** RED - Event Missing
  - **Verifies:** Barge-In Handling.
- ✅ **Test:** FR-042: Focus locking
  - **Status:** RED - Navigation occurred incorrectly
  - **Verifies:** Focus Locking during activity.

### Unit Tests (5 tests)

**Files:**
- `tests/unit/core/VoiceSanitization.test.ts`
- `tests/unit/core/AgentTools.test.ts`

- ✅ **Test:** NFR-008: Voice-Code Separation
  - **Status:** RED - Module Missing
  - **Verifies:** TTS never reads code or markdown.
- ✅ **Test:** FR-016: search_text shell syntax
  - **Status:** RED - Module Missing
  - **Verifies:** Proper escaping/encoding for shell tools.
- ✅ **Test:** FR-040: Smart Context Snapshot
  - **Status:** RED - Module Missing
  - **Verifies:** History included in prompt snapshot.

---

## Required data-testid Attributes

### Chat Panel
- `chat-textarea` - The main input for asking Theia questions.
- `thinking-indicator` - Shown when the agent is processing.
- `approval-modal` - The Gatekeeper modal.
- `approve-button` / `reject-button` - Actions in the modal.

### File Tree
- `full-repo-toggle` - Button to enable Full Repo Mode.
- `ghost-node` - Elements representing files not in PR.
- `lazy-loading-spinner` - Shown during ghost file fetch.

---

## Implementation Checklist

### Agent Logic (High Effort)
- [ ] Implement/Verify `AGENT_THINKING` state transitions for `tool_error`.
- [ ] Ensure `REPAIR_MODE` event is emitted with error context.
- [ ] Implement/Expose `formatSearchCommand` utility with base64/escaping.
- [ ] Implement `buildContextSnapshot` to include conversation history.

### Safety & Interactivity
- [ ] Verify `SENSITIVE_TOOLS` array in Gatekeeper includes `write_file`.
- [ ] Ensure `ApprovalRequest` modal sets action status to `pending_approval`.
- [ ] Implement `AGENT_YIELD` event trigger on user input during agent activity.
- [ ] Add 3-second activity check in navigation logic for focus locking.

### Performance & Voice
- [ ] Add `console.time` / `performance.now` instrumentation to lazy load.
- [ ] Implement `lazyFiles` Map caching in FileAdapter/Service.
- [ ] Implement `sanitizeForVoice` utility to strip backticks and code blocks.

---

## Running Tests

```bash
# Run all failing tests for these gaps
npx playwright test tests/agent-intelligence.spec.ts tests/safety-gate.spec.ts tests/performance-ux.spec.ts
npx vitest run tests/unit/core/VoiceSanitization.test.ts tests/unit/core/AgentTools.test.ts
```

---

## Red-Green-Refactor Workflow

### RED Phase (Complete) ✅
The TEA agent has verified that the 15 gaps are live and failing in the current codebase.

---

**Generated by Murat (TEA Agent)** - 2026-01-23
